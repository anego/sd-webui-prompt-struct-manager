# Prompt Struct Manager - 機能仕様書

## 1. プロンプト管理機能

### 1.1 階層構造 (Tree Structure)
- **Positive / Negative:** 2つの独立したツリーでプロンプトを管理。
- **グループ化:** フォルダを作成し、プロンプトをカテゴライズ可能。
- **無限ネスト:** グループの中にさらにグループを作成可能（深さ制限なし）。
- **並べ替え:** ドラッグ＆ドロップによる直感的な並べ替えに対応。

### 1.2 プロンプト編集
- **有効/無効切り替え:** チェックボックスにより、プロンプトを削除せずに一時的に無効化可能。親グループを無効化すると子要素もすべて出力から除外される。
- **重み付け (Weight):** `(word:1.2)` のようなSD WebUI形式の重み付けをGUIで調整可能。リセットボタンで即座に `1.0` に戻せる。
- **入力保管連携 (Tag Autocomplete):** 拡張機能 `a1111-sd-webui-tagcomplete` が有効な場合、プロンプト入力時にタグ候補の自動補完が利用可能。
- **メモ機能:** 各プロンプトに対して、ツールチップ等で確認可能なメモを付与可能。

### 1.3 ランダムグループ (Random Group)
- **Dynamic Prompts連携:** グループ内のプロンプトからランダムに1つを選択して生成する `{A|B|C}` 構文に対応。
- **専用スイッチ:** グループ名の横にある "Randomize Group" スイッチで簡単にON/OFF可能。
- **視認性:** ランダムモード時はグループ全体が紫色の点線枠で強調表示される。

### 1.4 一括操作 (Bulk Toggle)
- **Hover Actions:** グループヘッダーにマウスをホバーすると、一括操作用のアイコンが出現。
- **Enable All:** `[☑☑]` アイコンでグループ内の全アイテムを有効化。
- **Disable All:** `[☒]` アイコンでグループ内の全アイテムを無効化。

## 2. ユーザーインターフェース (UI/UX)

### 2.1 Group Map (グループマップ)
- 画面右側に常駐するナビゲーションバー。
- **機能:** 現在のツリー構造（グループのみ）を一覧表示。
- **クリックジャンプ:** 項目をクリックするだけで、該当するグループの位置まで自動スクロール。
- **視認性:** 深い階層構造に対応するため、インデントガイド（縦線）を表示して親子関係を可視化。
- **プロンプト数表示:** 各グループ名の横に、そのグループ内で有効なプロンプトの総数を表示。

### 2.2 ショートカットキー
- **Global Toggle:** 設定によりカスタマイズ可能（デフォルト: なし）。PSMパネルの表示/非表示を切り替え。
- **反映して閉じる:** `Ctrl + Shift + Enter` で現在のプロンプトをWebUIに反映し、パネルを閉じる。
- **キーボードナビゲーション:** 矢印キーでアイテム移動、F2で編集、Spaceで有効/無効切り替えが可能。

### 2.3 テーマとスタイル
- **Dark Mode:** WebUIのダークテーマに親和性の高いデザインを採用。
- **Vuetify 3:** マテリアルデザインベースのコンポーネントを使用。
- **Embedded Icons:** MDIアイコンフォントをインライン埋め込みし、描画崩れを防止。
- **Dynamic Prompts:** `__name__` 形式のプロンプトを自動検出し、シアン色+イタリック+専用アイコンで強調表示。ボタン形状も丸みを帯びたデザインに変更され、一目で区別可能。

### 2.4 初期セットアップウィザード (Setup Wizard)
- 初回起動時（または設定ファイル未検出時）に、保存先ディレクトリの選択と初期ファイルの作成をガイドするウィザードを表示。
- 以前の設定（WebUI側の設定）が残っている場合は自動的にそのパスを提案し、スムーズな移行をサポート。

### 2.5 マウス操作
- **ダブルクリック編集:** グループまたはプロンプトアイテムをダブルクリックすることで、素早く編集モード（設定モーダル）を開くことが可能。
- **右クリックメニュー:** アイテム上で右クリックするとコンテキストメニューを表示し、詳細な操作（複製、削除、移動など）にアクセス可能。

## 3. ファイル・設定管理

### 3.1 YAML永続化
- プロンプトデータはYAML形式でローカルディレクトリに保存される。
- **複数ファイル管理:** 用途に応じて複数のYAMLファイルを作成し、プルダウンで切り替え可能。
- **ファイル操作:** 新規作成、複製、リネーム、削除が可能。

### 3.2 グローバル設定
- **UIスケール:** Small / Medium / Large の3段階調整。
- **言語設定:** 日本語 / 英語 切替対応。
- **保存先 (Storage):** サイドバー最下部でYAMLファイルの保存先フォルダを変更可能。
- **ファイルリスト更新:** 更新ボタンにより、外部で変更されたファイル構成を再読み込み可能。

## 4. 開発者機能 (Dev Mode)
- **Debug Log:** `src/log.ts` により、開発モード時のみ詳細なデバッグ情報をコンソールに出力。
- **Import:** 開発者モード時のみ、外部からのインポート機能（実験的機能）がUIに表示される。
