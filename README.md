# SD WebUI Prompt Struct Manager (PSM)

Stable Diffusion WebUI (Automatic1111 / Forge) 向けの、プロンプトを構造的に管理するための拡張機能です。
プロンプトやネガティブプロンプトをツリー構造（グループ化）で整理し、ドラッグ＆ドロップでの並べ替えや有効/無効の切り替えを直感的に行うことができます。

本プロジェクトは「Stable Diffusion WebUI reForge」で動作確認しています。

## 主な機能

*   **構造化管理**: プロンプトをグループ（フォルダ）とアイテム（タグ）の階層構造で管理できます。
*   **直感的な操作**: ドラッグ＆ドロップによる並べ替え、階層移動が可能です。
*   **有効/無効の切り替え**: 各アイテムやグループごとのON/OFFをワンクリック（またはスペースキー）で切り替えられます。
*   **重み調整**: スライダー操作でプロンプトの重み（Weight）を調整できます。
*   **反映 & 閉じる**: PSM上で構築したプロンプトをWebUIにワンクリックで転送し、パネルを閉じます。
*   **文字列整形**: 連続するカンマを自動的に集約し、綺麗なプロンプトを生成します。
*   **ファイル管理**: プロンプト構成をYAMLファイルとして保存・読み込み・複製・リネームできます。
*   **キーボード操作**: 矢印キーでの移動、F2での編集、Deleteでの削除など、キーボードショートカットに対応しています。

## インストール方法

1.  SD WebUIの `Extensions` タブを開きます。
2.  `Install from URL` タブを選択します。
3.  `URL for extension's git repository` に本リポジトリのURLを入力します。
4.  `Install` ボタンを押します。
5.  `Installed` タブに戻り、`Apply and restart UI` をクリックしてWebUIを再起動します。

## 使い方

Extensionをインストールすると、WebUI上に「📂 PSM」ボタン（または専用の開閉ボタン）が表示されます（※UIの配置による）。

サイドバーの「言語 (Language)」切り替えスイッチで、日本語と英語を切り替えることができます。

### 初回セットアップ (Initial Setup)

拡張機能をインストールして最初の起動時、または設定ファイル (`config.json`) が存在しない場合、自動的にセットアップウィザードが表示されます。

1.  **保存先ディレクトリの選択**: プロンプトデータ (YAMLファイル) を保存するフォルダを指定します。
2.  **初期ファイルの作成**: 最初に作成するファイル名（例: `prompts`）を入力します。

ウィザードを完了すると、指定したフォルダに設定が保存され、すぐに使用を開始できます。

### 基本操作

*   **追加**: ルートまたグループの「ADD PROMPT」ボタン、または右クリックメニューから「新規プロンプト」「新規グループ」を追加します。
*   **編集**: アイテムをダブルクリック、または選択して `F2` キーで編集モードに入ります。
*   **削除**: アイテムを選択して `Delete` キー、または右クリックメニューから削除します。
*   **移動**: アイテムをドラッグ＆ドロップで並べ替えるか、右クリックメニュー「移動...」からグループを指定して移動できます。（サブメニューは右キー/マウスホバーで開き、左キーで戻れます）
*   **グループの並べ替え**: グループヘッダーにある「▲」「▼」ボタンをクリックして、グループの並び順を変更できます。
*   **有効化/無効化**: アイテム左側のチェックボックス、または選択して `Space` キーで切り替えます。
*   **反映 & 閉じる**: `Ctrl + Shift + Enter` でプロンプトをWebUIに反映し、PSMパネルを閉じます。（生成は実行しません）

### キーボードショートカット

*   `↑` `↓`: フォーカスの移動
*   `→`: グループを展開
*   `←`: グループを折りたたみ
*   `Space`: 有効/無効の切り替え
*   `F2`: 編集モード開始
*   `Ctrl + Enter`: 編集モード確定
*   `Delete`: 削除確認
*   `Insert`: 新規アイテム追加 (Shift+Insertでグループ追加)
*   `Shift + F10`: コンテキストメニュー表示
*   `Ctrl + Shift + Enter`: WebUIへ反映して閉じる (Apply & Close)

### ファイル保存

### ファイル保存 (Storage)

サイドバーのファイルリストから、現在の構成を `.yaml` ファイルとして保存できます。
「Storage」セクションでは、YAMLファイルの保存先フォルダを変更できます。フォルダアイコンをクリックして選択するか、パスを直接入力してください。

*   **リフレッシュ**: ファイルリスト横の更新ボタンで、ディレクトリ内のファイル一覧を再読み込みします。

## ライセンス

本拡張機能は [MIT License](LICENSE) の下で公開されています。
詳細は [LICENSE](LICENSE) ファイルを参照してください。

## 開発者向けドキュメント

より詳細な仕様については、以下のドキュメントを参照してください。

*   [概要仕様書 (OVERVIEW.md)](doc/OVERVIEW.md)
*   [機能仕様書 (FEATURES.md)](doc/FEATURES.md)
*   [データ構造仕様書 (DATA_STRUCTURE.md)](doc/DATA_STRUCTURE.md)
*   [開発者ガイド (DEVELOPMENT.md)](doc/DEVELOPMENT.md)

## 謝辞 / Credits

本プロジェクトは以下のオープンソースライブラリを使用しています。

*   [Vue.js](https://vuejs.org/) (MIT License)
*   [Vuetify](https://vuetifyjs.com/) (MIT License)
*   [Material Design Icons (@mdi/font)](https://materialdesignicons.com/) (Apache 2.0 License)
*   [Vue.Draggable](https://github.com/SortableJS/Vue.Draggable) (MIT License)
*   [SortableJS](https://github.com/SortableJS/Sortable) (MIT License)

